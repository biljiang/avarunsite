{% extends "analytics_R/index.html" %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">首页</a></li>
    <li class="breadcrumb-item"><a href={% url "analytics_R:index" %}>分析工具-R</a></li>
    <li class="breadcrumb-item active" aria-current="page">数据转换</li>
  </ol>
</nav>
{% endblock breadcrumbs %}



{% block main_txt_area %}

<div id="header">
<h1 class="title">Data Transformations</h1>
</div>


<hr />
<p>Once you have loaded raw data into R’s memory, you will often have a need to do various data transformations. For example, you might have a variable called <strong>gender</strong> in your raw data, taking values 0 and 1. This is a bad way of coding gender - what does 0 mean? <em>You</em> might know that males are coded as 0, but if you hand off your data to someone else, they will have no idea. So recode it as “male” and “female”. Similarly, suppose you have dates in your data and you want to know what day of the week each date correspond to. You then need to define a new variable with this information.</p>
<div id="example-new-york-taxi-trip-data" class="section level3">
<h3>Example: New York Taxi Trip Data</h3>
<p><img src="/static/analytics_R/taxi.jpg" align="right" alt="WWW" width="400" height="350" hspace="20"> This dataset contains information on every single trip taken with a yellow New York City taxi cab in the month of June, 2015. This is over 12 million trips! You can download a zip file with a 5% sample of the full data and code <a href="https://dl.dropboxusercontent.com/u/17328490/RAnalytics/lessons/Data%20Transformations.zip">here</a>, If you want the full data with all 12 million trips (256MB file), you can get that <a href="https://dl.dropboxusercontent.com/u/17328490/RAnalytics/data/yellow_trip_2015-06.rds">here</a>. You can download data in raw format for other months of the year <a href="http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml">here</a>.</p>
<p>In the following we will use the 5% sample. We start by loading the data:</p>
<pre class="r"><code>taxi &lt;- readRDS(&#39;data/yellow_trip_2015-06_small.rds&#39;)</code></pre>
<p>We will be using the <strong>dplyr</strong> package for transformations so let’s load this package and then use the <strong>glimpse</strong> command to peek at the data:</p>
<pre class="r"><code>library(dplyr)
glimpse(taxi)</code></pre>
<pre><code>## Observations: 616,619
## Variables: 18
## $ VendorID              (int) 1, 2, 2, 2, 2, 1, 2, 2, 1, 1, 2, 1, 2, 1...
## $ tpep_pickup_datetime  (time) 2015-06-01 07:05:49, 2015-06-07 04:17:2...
## $ tpep_dropoff_datetime (time) 2015-06-01 07:16:11, 2015-06-07 04:27:2...
## $ passenger_count       (int) 1, 5, 2, 1, 2, 1, 5, 1, 4, 1, 5, 1, 6, 1...
## $ trip_distance         (dbl) 1.70, 2.68, 1.17, 3.39, 0.69, 0.80, 1.49...
## $ pickup_longitude      (dbl) -73.96334, -73.94919, -73.98258, -73.991...
## $ pickup_latitude       (dbl) 40.76592, 40.71407, 40.77238, 40.75027, ...
## $ RateCodeID            (int) 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1...
## $ store_and_fwd_flag    (chr) &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, ...
## $ dropoff_longitude     (dbl) -73.98391, -73.90588, -73.99293, -73.996...
## $ dropoff_latitude      (dbl) 40.75550, 40.70319, 40.75834, 40.71296, ...
## $ payment_type          (int) 1, 2, 2, 1, 2, 2, 1, 2, 2, 1, 1, 1, 2, 1...
## $ fare_amount           (dbl) 9.0, 10.5, 7.5, 14.5, 6.5, 6.0, 8.5, 53....
## $ extra                 (dbl) 0.0, 0.5, 0.0, 0.5, 1.0, 0.5, 0.0, 0.0, ...
## $ mta_tax               (dbl) 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, ...
## $ tip_amount            (dbl) 1.00, 0.00, 0.00, 2.00, 0.00, 0.00, 1.86...
## $ tolls_amount          (dbl) 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0...
## $ total_amount          (dbl) 10.80, 11.80, 8.30, 17.80, 8.30, 7.30, 1...</code></pre>
<p>So there is a total of 616619 trips in the 5% sample and 18 variables in the data. As far as raw data goes this is in a pretty good condition. However, it still needs a few tweaks before we can start using it for analytics.</p>
<p>Let’s start by adding the week day of each trip. Day of week is not found in the original data. This only contains the date of each trip. For example, the first 5 trips were made on dates</p>
<pre class="r"><code>taxi$tpep_pickup_datetime[1:5]</code></pre>
<pre><code>## [1] &quot;2015-06-01 07:05:49 UTC&quot; &quot;2015-06-07 04:17:25 UTC&quot;
## [3] &quot;2015-06-21 18:11:47 UTC&quot; &quot;2015-06-14 20:54:44 UTC&quot;
## [5] &quot;2015-06-24 17:19:30 UTC&quot;</code></pre>
<p>We want to know what the day of week these dates correspond to. There are different ways to do this but when it comes to working with date and time functions it is a huge advantage to use functions from the <strong>lubridate</strong> package. Let’s load it:</p>
<pre class="r"><code>## use install.package(&quot;lubridate&quot;) first if you have not yet installed this package on your R system
library(lubridate) </code></pre>
<p>This library contains a neat function <strong>wday</strong> that returns the weekday of a date. We can then use this together with the <strong>mutate</strong> function to create a new variable in the <strong>taxi</strong> data:</p>
<pre class="r"><code>taxi.new &lt;- mutate(taxi,weekday = wday(tpep_pickup_datetime,label=TRUE,abbr=TRUE))</code></pre>
<p>Ok - what is going on here? This command “mutates” the orginal <strong>taxi</strong> data and turns it into a new data frame called <strong>taxi.new</strong>. This data frame will have 19 variables. In this case “mutate” simply means adding another variable to the data called <strong>weekday</strong>. The options to the <strong>wday</strong> function tells R that we wish text labels for each observation and that weekday abbreviations are to be used. With this done you can now easily count number of trips per weekday:</p>
<pre class="r"><code>table(taxi.new$weekday)</code></pre>
<pre><code>## 
##    Sun    Mon   Tues    Wed  Thurs    Fri    Sat 
##  75030  95128 100787  84369  86344  87838  87123</code></pre>
<p>Suppose we also wanted a variable capturing hour of the day in addition to weekday. We can use the <strong>hour</strong> command for this:</p>
<pre class="r"><code>taxi.new &lt;- mutate(taxi,
                   weekday = wday(tpep_pickup_datetime,label=TRUE,abbr=TRUE),
                   hour.trip.start = hour(tpep_pickup_datetime))</code></pre>
<p>This will create another variable capturing hour of the day of each trip. The first 5 trips were made at the following hours:</p>
<pre class="r"><code>taxi.new$hour.trip.start[1:5]</code></pre>
<pre><code>## [1]  7  4 18 20 17</code></pre>
<p>The <strong>hour</strong> function returns hour of day as a numeric variable. For later use it might be better to define as a <strong>factor</strong>. R calls categorical variables for “factors” and it is usually a good idea to force categorical variables to be factors:</p>
<pre class="r"><code>taxi.new &lt;- mutate(taxi,
                   weekday = wday(tpep_pickup_datetime,label=TRUE,abbr=TRUE),
                   hour.trip.start = factor(hour(tpep_pickup_datetime)))</code></pre>
<p>The number of trips by hour of day is</p>
<pre class="r"><code>table(taxi.new$hour.trip.start)</code></pre>
<pre><code>## 
##     0     1     2     3     4     5     6     7     8     9    10    11 
## 24264 17646 12743  9151  6943  6637 14299 23338 28572 28856 28153 29232 
##    12    13    14    15    16    17    18    19    20    21    22    23 
## 30085 29603 30592 28578 25182 30046 36109 37915 34861 36971 35448 31395</code></pre>
<p>You can keep adding further statements in the <strong>mutate</strong> function.</p>
<div id="exercise" class="section level4">
<h4>Exercise</h4>
<p>Find out what the data transformations <strong>transf1-transf4</strong> do to the original data. Give them names that are meaningful (i.e., replace the names transf1-transf4 with a new name that matches the meaning of the transformation). You probably want to use the R help function to aide you. For example <strong>help(difftime)</strong> will give you help on the <strong>difftime</strong> function.</p>
<pre class="r"><code>taxi.new &lt;- mutate(taxi,
                   weekday = wday(tpep_pickup_datetime,label=TRUE,abbr=TRUE),                             
                   hour.trip.start = factor(hour(tpep_pickup_datetime)),                                  
                   transf1 = factor(mday(tpep_dropoff_datetime)),                                             
                   transf2 = as.numeric(difftime(tpep_dropoff_datetime,tpep_pickup_datetime)/60),   
                   transf3 = ifelse(transf2 &gt; 1, trip_distance/(transf2/60), -1),
                   transf4 = cut(payment_type, 
                             breaks = c(0,1,2,5), 
                             labels=c(&#39;Credit Card&#39;,&#39;Cash&#39;,&#39;Other&#39;)))                           </code></pre>
</div>
</div>
</div>
{% endblock main_txt_area %}
